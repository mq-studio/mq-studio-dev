name: TinaCMS Vulnerability Monitor

# Monitors TinaCMS releases for patches to lodash.set, mermaid, and vite vulnerabilities
# Creates GitHub issue when new TinaCMS version is available
on:
  schedule:
    # Run weekly on Mondays at 11:00 UTC (after Dependabot runs)
    - cron: '0 11 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-tinacms-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Get current TinaCMS version
        id: current-version
        run: |
          CURRENT=$(npm list tinacms --depth=0 --json | jq -r '.dependencies.tinacms.version')
          echo "version=${CURRENT}" >> $GITHUB_OUTPUT
          echo "Current TinaCMS: ${CURRENT}"

      - name: Check for TinaCMS updates
        id: check-updates
        run: |
          npm view tinacms versions --json > tinacms-versions.json
          LATEST=$(npm view tinacms version)
          echo "latest=${LATEST}" >> $GITHUB_OUTPUT
          echo "Latest TinaCMS: ${LATEST}"

      - name: Check if update available
        id: needs-update
        run: |
          CURRENT="${{ steps.current-version.outputs.version }}"
          LATEST="${{ steps.check-updates.outputs.latest }}"
          if [ "$CURRENT" != "$LATEST" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "âœ… Update available: ${CURRENT} â†’ ${LATEST}"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Already on latest version: ${CURRENT}"
          fi

      - name: Check TinaCMS release notes
        id: release-notes
        if: steps.needs-update.outputs.update_available == 'true'
        run: |
          LATEST="${{ steps.check-updates.outputs.latest }}"
          # Fetch release notes from GitHub
          NOTES=$(gh api repos/tinacms/tinacms/releases/tags/v${LATEST} --jq '.body' 2>/dev/null || echo "No release notes available")
          
          # Check if security-related fixes are mentioned
          SECURITY_KEYWORDS="lodash|mermaid|vite|security|vulnerability|CVE"
          if echo "$NOTES" | grep -iE "$SECURITY_KEYWORDS" > /dev/null; then
            echo "has_security_fixes=true" >> $GITHUB_OUTPUT
            echo "ðŸ”’ Security-related changes detected in release notes"
          else
            echo "has_security_fixes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No obvious security fixes in release notes"
          fi
          
          # Save notes for issue creation
          echo "$NOTES" > release-notes.txt
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create issue for TinaCMS update
        if: steps.needs-update.outputs.update_available == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const current = '${{ steps.current-version.outputs.version }}';
            const latest = '${{ steps.check-updates.outputs.latest }}';
            const hasSecurity = '${{ steps.release-notes.outputs.has_security_fixes }}' === 'true';
            
            let releaseNotes = 'Release notes not available';
            try {
              releaseNotes = fs.readFileSync('release-notes.txt', 'utf8');
            } catch (e) {
              console.log('Could not read release notes');
            }

            const priority = hasSecurity ? '**P0 - CRITICAL**' : '**P2 - Medium**';
            const labels = hasSecurity 
              ? ['dependencies', 'security', 'tinacms', 'priority-high']
              : ['dependencies', 'tinacms'];

            const body = `## TinaCMS Update Available

${priority}

**Current Version:** ${current}
**Latest Version:** ${latest}
${hasSecurity ? 'ðŸ”’ **May contain security fixes for tracked vulnerabilities**' : ''}

### Tracked Vulnerabilities
This update may address:
- \`lodash.set\` (HIGH) - 7 instances in TinaCMS dependencies
- \`mermaid\` DOMPurify bundling (HIGH) - Admin-only
- \`vite\` (MODERATE) - Development server

### Release Notes
${releaseNotes}

### Testing Checklist
Before merging this update:
- [ ] Run \`npm install tinacms@${latest}\`
- [ ] Run \`npm audit\` and compare vulnerability count
- [ ] Run \`npm run build\` - verify successful build
- [ ] Run \`npm test\` - verify all tests pass (21/21)
- [ ] Test TinaCMS admin locally (\`npm run dev\`, navigate to \`/admin\`)
- [ ] Verify schema/content structure still works
- [ ] Check for breaking changes in [migration guide](https://tina.io/docs/migration/)

### Related Documents
- [VULNERABILITY_TRACKING.md](../VULNERABILITY_TRACKING.md)
- [Security Remediation Plan](../docs/SECURITY_REMEDIATION_PLAN.md)

### Automation
This issue was automatically created by the TinaCMS Vulnerability Monitor workflow.
Run manually: \`gh workflow run tinacms-vulnerability-monitor.yml\`
`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'tinacms'
            });

            const existingIssue = issues.data.find(issue => 
              issue.title.includes(`TinaCMS ${latest}`)
            );

            if (existingIssue) {
              console.log(`Issue already exists: #${existingIssue.number}`);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: 'ðŸ”” Reminder: TinaCMS update still pending review'
              });
            } else {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Update TinaCMS ${current} â†’ ${latest}`,
                body: body,
                labels: labels,
                assignees: [] // Add assignees if needed
              });
              console.log(`Created issue: #${issue.data.number}`);
            }

      - name: Summary
        run: |
          echo "### TinaCMS Vulnerability Monitor Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Current Version:** ${{ steps.current-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Latest Version:** ${{ steps.check-updates.outputs.latest }}" >> $GITHUB_STEP_SUMMARY
          echo "**Update Available:** ${{ steps.needs-update.outputs.update_available }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.needs-update.outputs.update_available }}" = "true" ]; then
            echo "**Security Fixes:** ${{ steps.release-notes.outputs.has_security_fixes }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… GitHub issue created for update" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸ No action needed - already on latest version" >> $GITHUB_STEP_SUMMARY
          fi
